<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AR Chair Placement</title>
<style>
  body { margin: 0; overflow: hidden; font-family: sans-serif; }
  #ui {
    position: fixed;
    top: 20px;
    left: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 10;
  }
  #ui button, #ui input[type="range"] {
    padding: 10px 20px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background-color: #007bff;
    color: white;
  }
  #model-scale {
    width: 150px;
  }
</style>
</head>
<body>

<!-- Overlay UI -->
<div id="ui">
  <button id="add-cart">Add to Cart</button>
  <button id="info">Info</button>
  <input type="range" id="model-scale" min="0.1" max="2" step="0.01" value="1">
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.161.1/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.161.1/examples/jsm/loaders/GLTFLoader.js';
import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.161.1/examples/jsm/webxr/ARButton.js';

let camera, scene, renderer, controller;
let reticle, chairModel;
const placedObjects = [];

init();

function init() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  // AR Button
  document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

  // Light
  const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
  scene.add(light);

  // Load chair model
  const loader = new GLTFLoader();
  loader.load('office_chair.glb', (gltf) => { chairModel = gltf.scene; });

  // Reticle for AR placement
  const geometry = new THREE.RingGeometry(0.1, 0.12, 32).rotateX(-Math.PI / 2);
  const material = new THREE.MeshBasicMaterial({ color: 0x0fff00 });
  reticle = new THREE.Mesh(geometry, material);
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);

  // Controller
  controller = renderer.xr.getController(0);
  controller.addEventListener('select', onSelect);
  scene.add(controller);

  // AR Hit Testing
  const hitTestSource = { source: null };
  renderer.xr.addEventListener('sessionstart', async () => {
    const session = renderer.xr.getSession();
    const viewerRefSpace = await session.requestReferenceSpace('viewer');
    hitTestSource.source = await session.requestHitTestSource({ space: viewerRefSpace });
    session.addEventListener('end', () => { hitTestSource.source = null; });
  });

  function onSelect() {
    if (reticle.visible && chairModel) {
      const clone = chairModel.clone();
      clone.position.setFromMatrixPosition(reticle.matrix);
      clone.quaternion.setFromRotationMatrix(reticle.matrix);
      scene.add(clone);
      placedObjects.push(clone);
    }
  }

  // Animation loop
  renderer.setAnimationLoop((timestamp, frame) => {
    if (frame) {
      const referenceSpace = renderer.xr.getReferenceSpace();
      const session = renderer.xr.getSession();
      const hitTestResults = frame.getHitTestResults(hitTestSource.source);
      if (hitTestResults.length) {
        const hit = hitTestResults[0];
        const pose = hit.getPose(referenceSpace);
        reticle.visible = true;
        reticle.matrix.fromArray(pose.transform.matrix);
      } else {
        reticle.visible = false;
      }
    }
    renderer.render(scene, camera);
  });

  // Handle resize
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // UI Controls
  document.getElementById('model-scale').addEventListener('input', (e) => {
    const scale = parseFloat(e.target.value);
    placedObjects.forEach(obj => obj.scale.set(scale, scale, scale));
  });

  document.getElementById('add-cart').addEventListener('click', () => {
    if (placedObjects.length > 0) alert(`${placedObjects.length} chair(s) added to cart!`);
    else alert("Place a chair first.");
  });

  document.getElementById('info').addEventListener('click', () => {
    alert("Tap the green circle to place a chair in AR. Use slider to scale.");
  });
}
</script>
</body>
</html>
